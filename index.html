
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>おこづかいゲット大作戦！</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    
const firebaseConfig = {
  apiKey: "AIzaSyB2t542oGMu1gTA_dkJaVTKhIm5JmeRvvs",
  authDomain: "allowance-calender.firebaseapp.com",
  projectId: "allowance-calender",
  storageBucket: "allowance-calender.firebasestorage.app",
  messagingSenderId: "49360595314",
  appId: "1:49360595314:web:ce1e89134df7539f2755eb"
};


    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const loginScreen = document.getElementById('login-screen');
    const mainApp = document.getElementById('main-app');
    const loginForm = document.getElementById('login-form');
    const errorMsg = document.getElementById('login-error');
    const userIdDisplay = document.getElementById('user-id-display');

    const USERS = {
      'child1': { password: '1234', role: 'child' },
      'parent1': { password: 'admin', role: 'parent' }
    };

    function logout() {
      localStorage.removeItem('userId');
      localStorage.removeItem('userRole');
      location.reload();
    }

    function saveStamp(day, type) {
      const uid = localStorage.getItem('userId');
      const role = localStorage.getItem('userRole');
      if (!uid || !role) return alert("ログインしてください");
      const now = new Date();
      const ym = `${now.getFullYear()}-${now.getMonth() + 1}`;
      const ref = doc(db, `artifacts/okozukai-app/users/${uid}/allowanceProgress/${ym}`);
      setDoc(ref, { [day]: { [type]: true } }, { merge: true })
        .then(() => alert("スタンプを保存しました"))
        .catch((e) => alert("保存エラー: " + e.message));
    }

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const id = document.getElementById('user-id-input').value.trim();
      const pw = document.getElementById('user-pass-input').value.trim();
      const role = document.getElementById('role-select').value;
      if (!USERS[id]) return errorMsg.textContent = "ユーザーIDが存在しません";
      if (USERS[id].password !== pw) return errorMsg.textContent = "パスワードが違います";
      if (USERS[id].role !== role) return errorMsg.textContent = "ロールが一致しません";
      localStorage.setItem('userId', id);
      localStorage.setItem('userRole', role);
      location.reload();
    });

    window.onload = () => {
      const uid = localStorage.getItem('userId');
      const role = localStorage.getItem('userRole');
      if (uid && role) {
        loginScreen.style.display = 'none';
        mainApp.style.display = 'block';
        userIdDisplay.innerHTML = `ログイン中：<strong>${uid}</strong>（${role === 'parent' ? '保護者' : '子ども'}）
          <button onclick="logout()" class="ml-2 text-sm text-blue-600 underline">ログアウト</button>`;
      } else {
        loginScreen.style.display = 'flex';
        mainApp.style.display = 'none';
      }
    };
  </script>
</head>
<body class="bg-[#F0F4F8]">

<!-- ログイン画面 -->
<div id="login-screen" class="hidden flex-col items-center justify-center min-h-screen text-center space-y-6">
  <h1 class="text-4xl font-extrabold text-[#073B4C]">おこづかいゲット大作戦！</h1>
  <p class="text-lg text-[#118AB2]">ログインしてスタンプを押そう！</p>
  <form id="login-form" class="flex flex-col space-y-4 w-72">
    <input type="text" id="user-id-input" placeholder="ユーザーID" class="border p-2 rounded text-center" required />
    <input type="password" id="user-pass-input" placeholder="パスワード" class="border p-2 rounded text-center" required />
    <select id="role-select" class="border p-2 rounded text-center">
      <option value="child">子どもモード</option>
      <option value="parent">保護者モード</option>
    </select>
    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">
      ログイン
    </button>
  </form>
  <p id="login-error" class="text-red-600 text-sm font-bold"></p>
</div>

<!-- メインアプリ画面 -->
<div id="main-app" class="hidden p-8 max-w-screen-md mx-auto bg-white rounded-xl shadow-lg">
  <div class="text-center mb-8">
    <h2 class="text-2xl font-bold mb-2">おこづかいカレンダー</h2>
    <p id="user-id-display" class="text-gray-600">ログイン中：...</p>
  </div>
  <div class="grid grid-cols-3 gap-4 text-center">
    <div class="bg-yellow-200 rounded-lg p-4">
      <p class="text-xl">📝</p>
      <button onclick="saveStamp(new Date().getDate(), 'signedUp')" class="mt-2 bg-white text-sm px-3 py-1 rounded shadow">勉強スタンプ</button>
    </div>
    <div class="bg-blue-200 rounded-lg p-4">
      <p class="text-xl">📖</p>
      <button onclick="saveStamp(new Date().getDate(), 'dailyTaskCompleted')" class="mt-2 bg-white text-sm px-3 py-1 rounded shadow">タスクスタンプ</button>
    </div>
    <div class="bg-red-200 rounded-lg p-4">
      <p class="text-xl">💪</p>
      <button onclick="saveStamp(new Date().getDate(), 'exerciseCompleted')" class="mt-2 bg-white text-sm px-3 py-1 rounded shadow">運動スタンプ</button>
    </div>
  </div>
</div>

</body>
</html>
