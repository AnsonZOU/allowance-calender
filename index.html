<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Åä„Åì„Å•„Åã„ÅÑ„Ç´„É¨„É≥„ÉÄ„Éº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1f2937;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 4px;
        }
        .day-cell {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        .day-cell:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .day-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 600;
        }
        .tasks-container {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .task-button {
            width: 32px;
            height: 32px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: background-color 0.2s;
            background-color: #e5e7eb;
        }
        .task-button.completed {
            background-color: #34d399;
        }
        .task-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 300px;
            margin: 2rem auto;
        }
        .progress-stamp {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            text-align: center;
        }
        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #FFD700;
            transition: height 0.5s ease-in-out;
            z-index: 0;
        }
        .progress-text {
            position: relative;
            z-index: 1;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        const appId = "okozukai-app";
        
const firebaseConfig = {
  apiKey: "AIzaSyB2t542oGMu1gTA_dkJaVTKhIm5JmeRvvs",
  authDomain: "allowance-calender.firebaseapp.com",
  projectId: "allowance-calender",
  storageBucket: "allowance-calender.firebasestorage.app",
  messagingSenderId: "49360595314",
  appId: "1:49360595314:web:ce1e89134df7539f2755eb"
};

        const initialAuthToken = null;

        const PARENT_USER_ID = "parent_user_id_placeholder";

        let db, auth, window.userId, isParent;
        let unsubscribe;
        let currentMonth = new Date();
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearDisplay = document.getElementById('month-year');
        const totalEarningsDisplay = document.getElementById('total-earnings');
        const userIdDisplay = document.getElementById('user-id-display');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        let monthlyChart;

        const FIXED_ALLOWANCE = 1000;
        const SIGNUP_AWARD = 100;
        const TASK_AWARD = 200;
        const BONUS_TIER1_COUNT = 10;
        const BONUS_TIER1_AMOUNT = 2000;
        const BONUS_TIER2_COUNT = 20;
        const BONUS_TIER2_AMOUNT = 4000;

        const SHOW_MESSAGE = (message, duration = 2000) => {
            modalMessage.textContent = message;
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.style.display = 'none';
            }, duration);
        };

        const renderMonthlyChart = (data) => {
            const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
            const totalSignupEarnings = Object.values(data).filter(d => d.signedUp).length * SIGNUP_AWARD;
            const totalTaskEarnings = Object.values(data).filter(d => d.dailyTaskCompleted).length * TASK_AWARD;
            const exerciseCount = Object.values(data).filter(d => d.exerciseCompleted).length;
            let bonusAmount = 0;
            if (exerciseCount >= BONUS_TIER2_COUNT) {
                bonusAmount = BONUS_TIER2_AMOUNT;
            } else if (exerciseCount >= BONUS_TIER1_COUNT) {
                bonusAmount = BONUS_TIER1_AMOUNT;
            }

            const ctx = document.getElementById('monthlyChart').getContext('2d');
            if (monthlyChart) {
                monthlyChart.destroy();
            }

            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Âõ∫ÂÆöË≤ª', 'ÂãâÂº∑', '„Çø„Çπ„ÇØ', '„Éú„Éº„Éä„Çπ'],
                    datasets: [{
                        label: 'Áç≤ÂæóÈáëÈ°çÔºàÂÜÜÔºâ',
                        data: [FIXED_ALLOWANCE, totalSignupEarnings, totalTaskEarnings, bonusAmount],
                        backgroundColor: ['#63B3ED', '#FFD166', '#06D6A0', '#FF6B6B'],
                        borderColor: ['#63B3ED', '#FFD166', '#06D6A0', '#FF6B6B'],
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const item = tooltipItems[0];
                                    let label = item.chart.data.labels[item.dataIndex];
                                    if (Array.isArray(label)) {
                                        return label.join(' ');
                                    } else {
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        };

        const updateUI = (data) => {
            const dayCells = calendarGrid.querySelectorAll('.day-cell');
            dayCells.forEach(cell => {
                const day = cell.dataset.day;
                const dailyData = data[day];
                const signupButton = cell.querySelector('[data-task="signedUp"]');
                const taskButton = cell.querySelector('[data-task="dailyTaskCompleted"]');
                const exerciseButton = cell.querySelector('[data-task="exerciseCompleted"]');

                if (signupButton && taskButton && exerciseButton) {
                    if (dailyData && dailyData.signedUp) {
                        signupButton.classList.add('bg-green-300', 'text-white');
                        signupButton.textContent = '‚úÖ';
                    } else {
                        signupButton.classList.remove('bg-green-300', 'text-white');
                        signupButton.textContent = 'üìù';
                    }

                    if (dailyData && dailyData.dailyTaskCompleted) {
                        taskButton.classList.add('bg-green-300', 'text-white');
                        taskButton.textContent = 'üìñ';
                    } else {
                        taskButton.classList.remove('bg-green-300', 'text-white');
                        taskButton.textContent = 'üìñ';
                    }
                    
                    if (dailyData && dailyData.exerciseCompleted) {
                        exerciseButton.classList.add('bg-green-300', 'text-white');
                        exerciseButton.textContent = 'üí™';
                    } else {
                        exerciseButton.classList.remove('bg-green-300', 'text-white');
                        exerciseButton.textContent = 'üí™';
                    }
                }
            });

            const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
            const signupCount = Object.values(data).filter(d => d.signedUp).length;
            const taskCount = Object.values(data).filter(d => d.dailyTaskCompleted).length;
            const exerciseCount = Object.values(data).filter(d => d.exerciseCompleted).length;

            document.getElementById('progress-bar-signup').style.height = `${(signupCount / daysInMonth) * 100}%`;
            document.getElementById('progress-text-signup').textContent = `ÂãâÂº∑ (${signupCount} / ${daysInMonth} Êó•)`;
            document.getElementById('progress-bar-task').style.height = `${(taskCount / daysInMonth) * 100}%`;
            document.getElementById('progress-text-task').textContent = `„Çø„Çπ„ÇØ (${taskCount} / ${daysInMonth} Êó•)`;
            document.getElementById('progress-bar-exercise').style.height = `${(exerciseCount / daysInMonth) * 100}%`;
            document.getElementById('progress-text-exercise').textContent = `ÈÅãÂãï (${exerciseCount} / ${daysInMonth} Êó•)`;

            if (signupCount === daysInMonth) document.getElementById('stamp-signup').style.backgroundColor = '#FFD700';
            else document.getElementById('stamp-signup').style.backgroundColor = '#fff';

            if (taskCount === daysInMonth) document.getElementById('stamp-task').style.backgroundColor = '#FFD700';
            else document.getElementById('stamp-task').style.backgroundColor = '#fff';

            if (exerciseCount === daysInMonth) document.getElementById('stamp-exercise').style.backgroundColor = '#FFD700';
            else document.getElementById('stamp-exercise').style.backgroundColor = '#fff';


            let totalDailyEarnings = signupCount * SIGNUP_AWARD + taskCount * TASK_AWARD;
            let bonusAmount = 0;
            if (exerciseCount >= BONUS_TIER2_COUNT) {
                bonusAmount = BONUS_TIER2_AMOUNT;
            } else if (exerciseCount >= BONUS_TIER1_COUNT) {
                bonusAmount = BONUS_TIER1_AMOUNT;
            }
            const totalMonthlyEarnings = FIXED_ALLOWANCE + totalDailyEarnings + bonusAmount;
            totalEarningsDisplay.textContent = `„Åù„ÅÆÊúà„ÅÆÂêàË®àÈáëÈ°ç: ${totalMonthlyEarnings.toLocaleString()}ÂÜÜ`;
            
            renderMonthlyChart(data);
        };

        const setupCalendar = (date) => {
            calendarGrid.innerHTML = '';
            monthYearDisplay.textContent = `${date.getFullYear()}Âπ¥ ${date.getMonth() + 1}Êúà`;
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
            const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            const today = new Date();

            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('day-cell', 'bg-gray-200', 'cursor-default');
                calendarGrid.appendChild(emptyCell);
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('day-cell', 'p-2', 'relative');
                dayCell.dataset.day = i;
                const dayDate = new Date(date.getFullYear(), date.getMonth(), i);
                const isPastOrToday = dayDate <= today;
                const isToday = dayDate.getDate() === today.getDate() && dayDate.getMonth() === today.getMonth() && dayDate.getFullYear() === today.getFullYear();
                
                const dayLabel = document.createElement('div');
                dayLabel.classList.add('day-label', 'absolute', 'top-2', 'left-2');
                dayLabel.textContent = i;
                dayCell.appendChild(dayLabel);
                
                const tasksContainer = document.createElement('div');
                tasksContainer.classList.add('flex', 'flex-col', 'items-center', 'justify-center', 'gap-2', 'mt-4');

                const tasks = ['signedUp', 'dailyTaskCompleted', 'exerciseCompleted'];
                const taskEmojis = {
                    signedUp: 'üìù',
                    dailyTaskCompleted: 'üìñ',
                    exerciseCompleted: 'üí™'
                };
                const taskColors = {
                    signedUp: 'bg-yellow-200',
                    dailyTaskCompleted: 'bg-blue-200',
                    exerciseCompleted: 'bg-red-200'
                };
                const taskTitles = {
                    signedUp: 'ÂãâÂº∑„ÇíÂÆå‰∫Ü',
                    dailyTaskCompleted: '„Çø„Çπ„ÇØ„ÇíÂÆå‰∫Ü',
                    exerciseCompleted: 'ÈÅãÂãï„ÇíÂÆå‰∫Ü'
                };

                tasks.forEach(task => {
                    const taskButton = document.createElement('button');
                    taskButton.classList.add('task-button', taskColors[task]);
                    taskButton.dataset.task = task;
                    taskButton.textContent = taskEmojis[task];
                    taskButton.title = taskTitles[task];
                    
                    if (isParent) {
                        taskButton.disabled = !isPastOrToday;
                    } else {
                        taskButton.disabled = !isToday;
                    }

                    if (taskButton.disabled) {
                        taskButton.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                         taskButton.classList.remove('opacity-50', 'cursor-not-allowed');
                         taskButton.classList.add(`hover:${taskColors[task].replace('200', '300')}`);
                         taskButton.addEventListener('click', () => handleTaskCompletion(i, task));
                    }
                    tasksContainer.appendChild(taskButton);
                });
                dayCell.appendChild(tasksContainer);
                calendarGrid.appendChild(dayCell);
            }
        };

        const handleTaskCompletion = async (day, task) => {
             if (!window.userId) {
                console.error("User not authenticated.");
                SHOW_MESSAGE("„É¶„Éº„Ç∂„ÉºË™çË®º„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
                return;
            }
            if(isParent) {
                SHOW_MESSAGE("„Çπ„Çø„É≥„Éó„ÇíÊâøË™ç„Åó„Åæ„Åô...", 1500);
            } else {
                SHOW_MESSAGE("ÂÜôÁúü„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...", 1500);
            }
            setTimeout(async () => {
                 try {
                    const docRef = doc(db, `artifacts/${appId}/users/${window.userId}/allowanceProgress`, `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}`);
                    await setDoc(docRef, { [day]: { [task]: true } }, { merge: true });
                    SHOW_MESSAGE("„Çπ„Çø„É≥„Éó„ÅåÊäº„Åï„Çå„Åæ„Åó„ÅüÔºÅ");
                } catch (e) {
                    console.error("Error setting task status: ", e);
                    SHOW_MESSAGE("„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ");
                }
            }, 1500);
        };

        const listenForUpdates = () => {
            if (unsubscribe) unsubscribe();
            if (!window.userId) {
                console.error("User not authenticated for listening.");
                return;
            }
            const docRef = doc(db, `artifacts/${appId}/users/${window.userId}/allowanceProgress`, `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}`);
            unsubscribe = onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    updateUI(doc.data());
                } else {
                    updateUI({});
                }
            }, (error) => {
                console.error("Error listening to document: ", error);
            });
        };

        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            setupCalendar(currentMonth);
            listenForUpdates();
        });

        document.getElementById('next-month').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            setupCalendar(currentMonth);
            listenForUpdates();
        });

        window.onload = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await new Promise(resolve => {
                    const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            window.userId = user.uid;
                            isParent = (window.userId === PARENT_USER_ID);
                            if(userIdDisplay) userIdDisplay.textContent = `„É¶„Éº„Ç∂„ÉºID: ${userId} (${isParent ? 'Ë¶™' : 'Â≠ê‰æõ'})`;
                            listenForUpdates();
                            unsubscribeAuth();
                            resolve();
                        } else {
                            if (initialAuthToken) {
                                try {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } catch (e) {
                                    console.error("Custom token sign-in failed, signing in anonymously.", e);
                                    await signInAnonymously(auth);
                                }
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                    });
                });
                setupCalendar(currentMonth);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                SHOW_MESSAGE("ÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            }
        };
    </script>
</head>
<body>

<!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
<div id="login-screen" class="hidden flex-col items-center justify-center min-h-screen text-center space-y-6">
  <h1 class="text-4xl font-extrabold text-[#073B4C]">„Åä„Åì„Å•„Åã„ÅÑ„Ç≤„ÉÉ„ÉàÂ§ß‰ΩúÊà¶ÔºÅ</h1>
  <p class="text-lg text-[#118AB2]">„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Çπ„Çø„É≥„Éó„ÇíÊäº„Åù„ÅÜÔºÅ</p>
  <form id="login-form" class="flex flex-col space-y-4 w-72">
    <input type="text" id="user-id-input" placeholder="„É¶„Éº„Ç∂„ÉºID" class="border p-2 rounded text-center" required />
    <input type="password" id="user-pass-input" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" class="border p-2 rounded text-center" required />
    <select id="role-select" class="border p-2 rounded text-center">
      <option value="child">Â≠ê„Å©„ÇÇ„É¢„Éº„Éâ</option>
      <option value="parent">‰øùË≠∑ËÄÖ„É¢„Éº„Éâ</option>
    </select>
    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">
      „É≠„Ç∞„Ç§„É≥
    </button>
  </form>
  <p id="login-error" class="text-red-600 text-sm font-bold"></p>
</div>
 class="bg-gray-100 p-8 flex flex-col items-center">
    <div id="modal" class="modal">
        <div class="modal-content rounded-lg shadow-lg">
            <p id="modal-message" class="text-xl font-bold"></p>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-4xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">„Åä„Åì„Å•„Åã„ÅÑ„Ç´„É¨„É≥„ÉÄ„Éº</h1>
            <p class="text-gray-600" id="user-id-display">„É¶„Éº„Ç∂„ÉºID: ...</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div id="stamp-signup" class="progress-stamp p-4 flex flex-col items-center justify-center">
                <div class="progress-bar" id="progress-bar-signup"></div>
                <h3 class="font-bold text-xl mb-2 progress-text">üìù</h3>
                <p id="progress-text-signup" class="progress-text">ÂãâÂº∑</p>
            </div>
            <div id="stamp-task" class="progress-stamp p-4 flex flex-col items-center justify-center">
                <div class="progress-bar" id="progress-bar-task"></div>
                <h3 class="font-bold text-xl mb-2 progress-text">üìñ</h3>
                <p id="progress-text-task" class="progress-text">„Çø„Çπ„ÇØ</p>
            </div>
            <div id="stamp-exercise" class="progress-stamp p-4 flex flex-col items-center justify-center">
                <div class="progress-bar" id="progress-bar-exercise"></div>
                <h3 class="font-bold text-xl mb-2 progress-text">üí™</h3>
                <p id="progress-text-exercise" class="progress-text">ÈÅãÂãï</p>
            </div>
        </div>

        <div class="flex justify-between items-center mb-6">
            <button id="prev-month" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300 transition-colors">‚Üê</button>
            <h2 id="month-year" class="text-2xl font-bold text-center"></h2>
            <button id="next-month" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300 transition-colors">‚Üí</button>
        </div>
        <div class="grid grid-cols-7 text-center font-bold text-gray-500 mb-2">
            <div>Êó•</div><div>Êúà</div><div>ÁÅ´</div><div>Ê∞¥</div><div>Êú®</div><div>Èáë</div><div>Âúü</div>
        </div>
        <div id="calendar-grid" class="calendar-grid"></div>
        <div class="mt-8 text-center text-3xl font-bold text-green-700">
            <p id="total-earnings">„Åù„ÅÆÊúà„ÅÆÂêàË®àÈáëÈ°ç: 0ÂÜÜ</p>
        </div>
        <div class="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h3 class="font-bold text-gray-700 mb-2">‰Ωø„ÅÑÊñπ:</h3>
            <ul class="text-gray-600 list-disc list-inside">
                <li><span class="font-bold text-yellow-500">üìù</span> „ÇíÊäº„Åô„Å®„ÄÅÂãâÂº∑ÂÆå‰∫Ü„Çπ„Çø„É≥„Éó„ÅåÊäº„Åï„Çå„Åæ„Åô„ÄÇ</li>
                <li><span class="font-bold text-blue-500">üìñ</span> „ÇíÊäº„Åô„Å®„ÄÅ„Çø„Çπ„ÇØÂÆå‰∫Ü„Çπ„Çø„É≥„Éó„ÅåÊäº„Åï„Çå„Åæ„Åô„ÄÇ</li>
                <li><span class="font-bold text-red-500">üí™</span> „ÇíÊäº„Åô„Å®„ÄÅÈÅãÂãïÂÆå‰∫Ü„Çπ„Çø„É≥„Éó„ÅåÊäº„Åï„Çå„Åæ„Åô„ÄÇ</li>
                <li>„Çπ„Çø„É≥„Éó„ÇíÊäº„Åô„Å®„ÄÅËÉåÊôØËâ≤„ÅåÂ§â„Çè„ÇäÂÆå‰∫Ü„Åó„Åü„Åì„Å®„Åå„Çè„Åã„Çä„Åæ„Åô„ÄÇ</li>
            </ul>
        </div>
        <div class="mt-8 p-4 bg-white rounded-lg shadow-lg">
            <h3 class="text-2xl font-bold text-center mb-4">‰ªäÊúà„ÅÆ„Åä„Åì„Å•„Åã„ÅÑÈÄ≤Êçó</h3>
            <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
    </div>

<script>
  const loginScreen = document.getElementById('login-screen');
  const mainApp = document.querySelector('.bg-white.rounded-xl.shadow-lg');
  const loginForm = document.getElementById('login-form');
  const errorMsg = document.getElementById('login-error');
  const userIdDisplay = document.getElementById('user-id-display');

  const USERS = {
    'child1': { password: '1234', role: 'child' },
    'parent1': { password: 'admin', role: 'parent' }
  };

  function logout() {
    localStorage.removeItem('userId');
    localStorage.removeItem('userRole');
    
      loginScreen.style.display = 'none';
      if (mainApp) mainApp.style.display = 'block';
      if (userIdDisplay) {
        userIdDisplay.innerHTML = `„É≠„Ç∞„Ç§„É≥‰∏≠Ôºö<strong>${id}</strong>Ôºà${role === 'parent' ? '‰øùË≠∑ËÄÖ' : 'Â≠ê„Å©„ÇÇ'}Ôºâ
          <button onclick="logout()" class="ml-2 text-sm text-blue-600 underline">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>`;
      }
      window.isParent = (role === 'parent');
      window.userId = id;
      if (typeof renderCalendar === 'function') renderCalendar();
    
  }

  
loginForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const role = document.getElementById('role-select').value;
  errorMsg.textContent = '';  // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏ÂàùÊúüÂåñ

  if (role === 'child') {
    const id = 'child1';
    localStorage.setItem('userId', id);
    localStorage.setItem('userRole', 'child');
    loginScreen.style.display = 'none';
    if (mainApp) mainApp.style.display = 'block';
    if (userIdDisplay) {
      userIdDisplay.innerHTML = `„É≠„Ç∞„Ç§„É≥‰∏≠Ôºö<strong>${id}</strong>ÔºàÂ≠ê„Å©„ÇÇÔºâ
        <button onclick="logout()" class="ml-2 text-sm text-blue-600 underline">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>`;
    }
    window.isParent = false;
    window.userId = id;
    if (typeof renderCalendar === 'function') renderCalendar();
    return;
  }

  const id = document.getElementById('user-id-input').value.trim();
  const pw = document.getElementById('user-pass-input').value.trim();
  if (id !== 'parent1' || pw !== 'admin') {
    errorMsg.textContent = 'ID„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô';
    return;
  }

  localStorage.setItem('userId', id);
  localStorage.setItem('userRole', 'parent');
  loginScreen.style.display = 'none';
  if (mainApp) mainApp.style.display = 'block';
  if (userIdDisplay) {
    userIdDisplay.innerHTML = `„É≠„Ç∞„Ç§„É≥‰∏≠Ôºö<strong>${id}</strong>Ôºà‰øùË≠∑ËÄÖÔºâ
      <button onclick="logout()" class="ml-2 text-sm text-blue-600 underline">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>`;
  }
  window.isParent = true;
  window.userId = id;
  if (typeof renderCalendar === 'function') renderCalendar();
});

    
  });

  window.addEventListener('DOMContentLoaded', () => {
  if (typeof renderCalendar === 'function') renderCalendar();
    const uid = localStorage.getItem('userId');
    const role = localStorage.getItem('userRole');
    if (uid && role) {
      loginScreen.style.display = 'none';
      if (mainApp) mainApp.style.display = 'block';
      if (userIdDisplay) {
        userIdDisplay.innerHTML = `„É≠„Ç∞„Ç§„É≥‰∏≠Ôºö<strong>${uid}</strong>Ôºà${role === 'parent' ? '‰øùË≠∑ËÄÖ' : 'Â≠ê„Å©„ÇÇ'}Ôºâ
          <button onclick="logout()" class="ml-2 text-sm text-blue-600 underline">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>`;
      }
      window.isParent = (role === 'parent');
      window.window.userId = uid;
    } else {
      loginScreen.style.display = 'flex';
      if (mainApp) mainApp.style.display = 'none';
    }
  });
</script>

</body>
</html>
